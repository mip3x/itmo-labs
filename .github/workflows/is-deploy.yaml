name: IS-Deploy

on:
  push:
    branches:
      - "feature/information-system-lab-2-diff"

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: third-year/information-systems/lab2/backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run tests
        run: ./gradlew --no-daemon test

      - name: Mark as success
        if: ${{ success() }}
        run: echo "[Tests passed]" >> $GITHUB_STEP_SUMMARY

      - name: Mark as failed
        if: ${{ failure() }}
        run: echo "[Tests failed]" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'push' }}

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.IS_DEPLOY_HOST }}
          username: ${{ secrets.IS_DEPLOY_USER }}
          key: ${{ secrets.IS_DEPLOY_SSH_KEY }}
          port: ${{ secrets.IS_DEPLOY_PORT }}
          script: |
            set -euo pipefail

            echo "Go to deploy dir..."
            cd "${{ secrets.IS_DEPLOY_PATH }}"

            echo "Update repo..."
            git fetch origin
            git checkout feature/information-system-lab-2-diff
            git reset --hard origin/feature/information-system-lab-2-diff

            echo "Build & restart containers..."
            docker compose up -d --build --remove-orphans

            echo "Prune old images (safe)..."
            docker image prune -f

